#
# This is the XenServer patch queue for Qemu Traditional
#
# This has built up through years of neglect and hacking.  As Qemu Traditional
# is EOL upstream, with the encouragement to move to a non-forked version of
# ancient Qemu, this patch queue will likely stay quite large.
#
# Work will be done where possible to reduce its size and invasiveness, but
# the most important aspect is to ensure that there is no breakage of migrated
# VMs; there are many changes here which unfortunately cannot be taken out.
#

#
# Build System
#
out-of-xen-build.patch
xenserver-build-tweaks.patch
coverity-model.patch
builder-makefiles.patch

#
# Patches from upstream (qemu-traditional upstream)
#

#
# Patches from upstream (qemu-upstream upstream)
#

#
# Patches for upstream (qemu-traditional)
#

# Build fixes
0003-virtio-blk-initialize-unused-blkcfg.size_max-field.patch
cirrus_vga-default-all-I-O-port-reads-to-0xff.patch
lm832x-don-t-overrun-file-buffer-on-save-restore.patch
block-vvfat-fix-fat_chksum-buffer-overrun-warning.patch

# CVE fixes
CVE-2010-0297-usb-overflow.patch
0001-CVE-2014-8106-cirrus-fix-blit-region-check.patch
0002-CVE-2014-7815-vnc-sanitize-bits_per_pixel-from-the-c.patch
0003-CVE-2014-3615-vbe-rework-sanity-checks.patch

# Crash fixes
0001-cirrus_vga-fix-division-by-0-for-color-expansion-rop.patch
0001-cancel-dma-operation-if-command-abort-or-error.patch
0002-fix-incorrect-bh-schedule.patch

# Functional fixes
fix-cdrom-eject.patch
fix-pasprintf.patch
CP-10662-pciemulation.patch
less-leaky-xenstore-handling.patch

# Scalability fixes
smbus-nuke-eeprom.patch

# Valgrind/Coverity fixes
clear-dynticks-sigevent.patch
reduce-memory-leaks.patch
hw-msmouse-Fix-deref_after_free.patch
0001-readline-fix-memory-corruption-when-adding-history.patch
0002-block-cow-dont-close-cow_fd-twice-on-error.patch
0003-console-font_data-is-only-8-bits.patch
0004-hw-device-hotplug-fix-test-of-drive_add-return.patch
0005-qemu-char-fix-memory-leak-in-qemu_char_open_pty.patch
0006-hw-ide-fix-memory-leak-from-qemu_allocate_irqs.patch
0007-net-dont-leak-an-fd-after-an-error.patch
0008-net-fix-memory-handle-leaks-in-net_socket_listen_init.patch
0009-block-vvfat-fix-memory-handle-leaks-in-commit_one_file.patch
0010-block-vvfat-fix-memory-leak-in-check_directory_consistenccy.patch
0004-virtio-blk-correctly-link-new-request-in-virtio_blk_load.patch
0005-net-initialize-addrlen-param-in-getsockname-call.patch
0006-net-initialize-saddr-before-getsockname-call.patch
0007-ide-dont-leak-irq-array-in_pci_cmd646_ide_init.patch
0008-block-nbd-close-sock-in-nbd_open-error_path.patch
0009-block-raw-posix-Fix-memory-leak-in-posix_aio_init.patch
0010-block-vvfat-fix-memory-leak-in-read_directory.patch
0011-block-vvfat-close-dir-in-read_directory-error-path.patch

#
# Non-upstreamable patches
#
fix-migrate-from-Boston-thru-Clearwater.patch


######################################################################
# Everything below this point is technical debt of one form or another

#
# reversions
#
revert-f95d202ed6444dacb15fbea4dee185eb0e048d9a.patch
revert-7440-f37b6dee9f16.patch

#
# patches from qemu upstream
#
qemu-753b4053311ff1437d99726970b1e7e6bf38249b.patch # Support multiple VNC clients, pull vnc.c + compatibility fixes
qemu-6baebed7698a37a0ac5168faf26023426b0ac940.patch # vnc: cleanup surface handling, fix screen corruption bug. (Gerd Hoffmann)
qemu-c522d0e2dee3774884a731691a702126901a1a88.patch # vnc: throttle screen updates. (Gerd Hoffmann)
qemu-3cded5400925452fcd1adca9109a5d30a92b4dac.patch # vnc: Fix incorrect attempt to clear a flag
qemu-0fc8e0ec7f42fb79763b875edea2f50c0691c1f4.patch # vnc: windup keypad keys for qemu console emulation
qemu-bee1b01083b6adcf580fa30e65a2e59e7231af31.patch # vnc: fix segfault
qemu-89ee676eadde78677addb74ef8f356757f6f6c0a.patch # vnc: fix server surface pixel format.
qemu-24cf0a6e36402f3bbab1d7317de6c4d511c832e1.patch # vnc: no need to set force_update for incremental update requests.
qemu-afd3216027e3b28b0e180ac99d87e981d169b91c.patch # vnc: Fix memory allocation (wrong structure size).
qemu-198a0039c5fca224a77e9761e2350dd9cc102ad0.patch # vnc: rework VncState release workflow.
qemu-f22f5b077c164b864dae9776f63ed9e48a973fb6.patch # vga: fix shadow GR regression

vnc_copyrect.patch # where does this come from?
vnc_timer.patch
vnc_single_server_surf.patch
vnc_dynamic_timer.patch
vnc_update_policy.patch # where does this come from?
vnc_refresh_vnc_disconnect.patch # not fixed this way upstream
qemu-5d95ac5b6475c3b6b0e36b5f04de49bba88b3e59.patch # vnc: fix use after free
qemu-83755c173f4608764e3ee92428247d1c5e962e6a.patch # vnc_refresh: return if vd->timer is NULL

#
# to go upstream
#
fix_savevm_v1_compatibility.patch
savevm_george_compatibility.patch
sanify-usb-controller-setup.patch
monitor_on_xenstore.patch
cdrom_insert_open_flags.patch
fix_rtl_saverestore.patch
vga-clear-fb-on-switch-to-graphic.patch
unplug-version-2.patch
CA-55725-retry-after-listen-fail.patch
CP-3235.patch
product-nr-3-blacklist.patch
product-nr-4-blacklist.patch
product-nr-1-blacklist.patch
0001-vga-map-VRAM-when-BAR-is-updated-enabled.patch

#
# Compatible with upstream but not worth the effort of upstreaming
#
qemu-3.4-fdc.patch
hvm-late-unpause.patch
xen-platform-scsi-controller.patch
xenstore_set_device_locked.patch
close-and-flush-disconnected-emulated-devices.patch
qemu-logconsole-to-file.patch
qemu-dont-probe-disk-format.patch
qemu-force-lba-geometry.patch
qemu-fix-tap-open-race-CA-8496.patch
CA-8472.patch
CA-10912-silence-parallel-msg.patch
qemu-enforce-read-only-CA-12833.patch
acpi-wake-timer.patch
qemu-keymap.patch
vnc_clipboard.patch
vnclisten.patch
vnc-port.patch
vnc_scan_code.patch
vnc_xencenter_no_copyrect.patch
large_resolution.patch


#
# Product specific
#
enable_cirrus_irq.patch
xenstore-exit-on-domain-destruction.patch # does not work with stubdom
set_timeoffset.patch
qemu-use-backdev.patch

#
# Product specific, incompatible with Open Source
#
move-disable-pf-key.patch
CA-32196-disable-fw-cfg.patch
abort-on-bad-loadvm.patch
savevm_dummy_handler_for_pcislots.patch
fix-vnc-overflow.patch
fix_term_handling_if_paused.patch # upstream does not present same problem
vnc_checks.patch
CA-86932-disable-console-for-parallel-port.patch
CA-87350-fix-qemu-crash-on-snapshot.patch
constant_devfn_for_nic.patch
evtchn_io_old_xen.patch
less_xs_connection.patch
XOP-403-usb-blue-fix.patch
CA-123830-reenable-O_DIRECT.patch
CA-127361.patch
vgpu.patch
fixed-devfn.patch
Xen-vm-kernel-crash-in-get_free_entries-workaround.patch
vnc-dynamically-alloc-dirty-buffers.patch
syslog_support.patch
name2keysym_constant.patch
ioport_memory.patch
zlib_leak.patch
dynamic_vnc.patch
unselect_console.patch
vga_const.patch
no_icount.patch
pci_emulation_size.patch
main_loop.patch
cache_get_clock.patch
usb_timer.patch
vnc_limit.patch
vnc_buffer_mmap.patch
fix-option-rom-mapping.patch
dirty.patch
depriv_qemu.patch
notify.patch
CA-144613-vnc.patch
CA-147808-vnc.patch
CA-156663-ioperms.patch
0001-vnc-handle-guest-ds-with-strange-width.patch
0002-vga-fix-invalid-memory-accesses-with-bad-register-state.patch
# future Intel drivers will not require this patch but it is required to 
# support existing vm upgrade to dundee
igd_passthrough.patch
